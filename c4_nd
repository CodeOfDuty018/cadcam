#include <LiquidCrystalSerial.h>
#include <Keypad.h>

// Chân kết nối shift register
#define SH_CP 1
#define DS    0
#define ST_CP 2

// Khởi tạo LCD với shift register
LiquidCrystalSerial lcd(SH_CP, DS, ST_CP);

// Cấu hình keypad 4x3
const byte ROWS = 4;  // Số hàng
const byte COLS = 3;  // Số cột
char keys[ROWS][COLS] = {  // Bố trí phím trên keypad
  {'1', '2', '3'},
  {'4', '5', '6'},
  {'7', '8', '9'},
  {'*', '0', '#'}
};
byte rowPins[ROWS] = {3, 4, 5, 6};  // Chân hàng kết nối với vi điều khiển
byte colPins[COLS] = {7, 8, 9};     // Chân cột kết nối với vi điều khiển

// Khởi tạo đối tượng keypad
Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

// Biến lưu trữ dãy số người dùng nhập
String inputCode = "";
String password = "7355608";  // Mật khẩu mặc định
String inputPassword = "";  // Mật khẩu người dùng nhập
int totalSeconds = 0;
int minutes = 0;
int seconds = 0;
bool timeEntered = false;  // Trạng thái nhập thời gian
bool passwordEntered = false;  // Trạng thái nhập mật khẩu
bool timerRunning = false;

void setup() {
  lcd.begin(16, 2);  // Cấu hình LCD 16x2
  lcd.print("Nhap thoi gian:");  // Bắt đầu bằng nhập thời gian
}

void loop() {
  char key = keypad.getKey();

  if (!timeEntered) {  // Nếu thời gian chưa được nhập
    if (key) {
      if (key == '#') {  // Khi nhấn '#', xác nhận thời gian
        if (inputCode.length() > 0) {
          totalSeconds = inputCode.toInt();  // Chuyển thành giây
          minutes = totalSeconds / 60;
          seconds = totalSeconds % 60;

          lcd.clear();
          lcd.print("Time: ");
          lcd.print(minutes);
          lcd.print(":");
          if (seconds < 10) lcd.print("0");
          lcd.print(seconds);
          delay(1000);

          timeEntered = true;  // Đánh dấu đã nhập thời gian
          inputCode = "";  // Xóa mã nhập
          lcd.clear();
          lcd.print("Nhap mat khau:");
        }
      } else if (key == '*') {  // Xóa ký tự cuối
        if (inputCode.length() > 0) {
          inputCode.remove(inputCode.length() - 1);
        }
        lcd.clear();
        lcd.print("Nhap thoi gian:");
        lcd.setCursor(0, 1);
        lcd.print(inputCode);
      } else {  // Nhập ký tự vào
        if (inputCode.length() < 4) {  // Giới hạn 4 ký tự
          inputCode += key;
          lcd.clear();
          lcd.print("Nhap thoi gian:");
          lcd.setCursor(0, 1);
          lcd.print(inputCode);
        }
      }
    }
  } else if (!passwordEntered) {  // Nếu mật khẩu chưa được nhập
    if (key) {
      if (key == '#') {  // Xác nhận mật khẩu
        inputPassword.trim();
        if (inputPassword == password) {  // Mật khẩu đúng
          passwordEntered = true;
          inputPassword = "";  // Xóa mật khẩu
          lcd.clear();
          lcd.print("Dem nguoc bat dau!");
          delay(1000);
          timerRunning = true;  // Bắt đầu đếm ngược
        } else {  // Mật khẩu sai
          inputPassword = "";  // Xóa mật khẩu
          lcd.clear();
          lcd.print("Sai mat khau!");
          delay(1000);
          lcd.clear();
          lcd.print("Nhap mat khau:");
        }
      } else if (key == '*') {  // Xóa ký tự cuối
        if (inputPassword.length() > 0) {
          inputPassword.remove(inputPassword.length() - 1);
        }
        lcd.clear();
        lcd.print("Nhap mat khau:");
        lcd.setCursor(0, 1);
        lcd.print(inputPassword);
      } else {  // Nhập thêm ký tự
        if (inputPassword.length() < 7) {  // Giới hạn 7 ký tự
          inputPassword += key;
          lcd.clear();
          lcd.print("Nhap mat khau:");
          lcd.setCursor(0, 1);
          lcd.print(inputPassword);
        }
      }
    }
  } else if (timerRunning) {  // Nếu đang đếm ngược
    if (seconds == 0 && minutes == 0) {
      lcd.clear();
      lcd.print("Time's up!");
      delay(1000);
      timerRunning = false;
    } else {
      if (seconds == 0) {
        if (minutes > 0) {
          minutes--;
          seconds = 59;
        }
      } else {
        seconds--;
      }

      lcd.clear();
      lcd.print("Thoi gian: ");
      lcd.print(minutes);
      lcd.print(":");
      if (seconds < 10) lcd.print("0");
      lcd.print(seconds);
      delay(1000);  // Giảm từng giây
    }
  }
}
