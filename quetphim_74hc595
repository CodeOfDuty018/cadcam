#include <ShiftRegister74HC595.h>

// Khởi tạo IC 74HC595 (DATA, CLOCK, LATCH)
const int dataPin = 2;  // DATA
const int clockPin = 3; // CLOCK
const int latchPin = 4; // LATCH

ShiftRegister74HC595<1> sr(dataPin, clockPin, latchPin); // 1 IC 74HC595

// Mảng lưu mã phím bàn phím 3x4
char keypad[3][4] = {
  {'1', '2', '3', 'A'},
  {'4', '5', '6', 'B'},
  {'7', '8', '9', 'C'}
};

// Hàng của bàn phím
const int rowPins[3] = {5, 6, 7}; // Hàng

// Trạng thái các cột
uint8_t colState[] = {0b0001, 0b0010, 0b0100, 0b1000};

// LED kết nối Q4 (bit số 4 trong thanh ghi)
const int ledBit = 4;

void setup() {
  Serial.begin(9600);

  // Cấu hình hàng là INPUT_PULLUP
  for (int i = 0; i < 3; i++) {
    pinMode(rowPins[i], INPUT_PULLUP);
  }
}

void loop() {
  for (int col = 0; col < 4; col++) {
    // Tắt toàn bộ cột để tránh xung đột tín hiệu
    sr.setAll(0b0000);
    delay(1); // Đợi một chút để tín hiệu ổn định

    // Kích hoạt cột hiện tại
    sr.setAll(colState[col]);

    // Đọc hàng
    for (int row = 0; row < 3; row++) {
      if (digitalRead(rowPins[row]) == LOW) {
        Serial.print("Key Pressed: ");
        Serial.println(keypad[row][col]);

        // Bật LED khi nhận phím
        sr.set(ledBit, HIGH); // Bật LED
        delay(200);           // Chống rung phím
        sr.set(ledBit, LOW);  // Tắt LED
      }
    }
  }
}

